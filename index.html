<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="data:,">
    
    <title>Guide Michelin SIL - V29 Van</title>
    
    <!-- FONTS & ICONS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- LEAFLET -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <!-- GOOGLE AUTH -->
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --primary: #E11D48;
            --accent: #0F172A;
            --c-high: #16a34a; 
            --c-med: #f59e0b;
            --c-low: #ef4444;
            --c-new: #3b82f6; 

            --shadow-hard: 0 4px 15px rgba(0, 0, 0, 0.12);
            --radius-md: 14px;
            --radius-xl: 24px;
            --font-body: 'Inter', sans-serif;
            --font-display: 'Playfair Display', serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; width: 100%; height: 100dvh; font-family: var(--font-body); background: #f2f2f2; overflow: hidden; position: fixed; }

        /* --- MAP --- */
        #map { position: absolute; inset: 0; z-index: 0; background: #e5e5e5; }
        .leaflet-interactive { cursor: pointer !important; pointer-events: auto !important; }

        /* --- UI LAYER --- */
        .ui-layer {
            position: absolute; inset: 0; z-index: 1000; pointer-events: none;
            display: flex; flex-direction: column;
        }
        
        /* HEADER */
        .header-wrap {
            padding: max(10px, env(safe-area-inset-top)) 16px 10px;
            display: flex; flex-direction: column; gap: 12px;
            pointer-events: none; 
        }

        .top-row { display: flex; justify-content: space-between; align-items: center; pointer-events: none; }
        
        .app-title {
            font-family: var(--font-display); font-size: 20px; font-weight: 800; color: var(--primary);
            background: white; padding: 6px 16px; border-radius: 30px; 
            box-shadow: var(--shadow-hard); display: flex; align-items: center; gap: 8px; pointer-events: auto;
        }

        .btn-icon {
            width: 44px; height: 44px; border-radius: 50%; background: white; border: none;
            color: #333; font-size: 18px; box-shadow: var(--shadow-hard);
            cursor: pointer; pointer-events: auto;
            display: flex; align-items: center; justify-content: center; transition: 0.1s;
        }
        .btn-icon:active { transform: scale(0.9); }
        .btn-icon.connected { color: var(--c-high); border: 2px solid var(--c-high); }
        .btn-icon.syncing { color: var(--c-med); border: 2px solid var(--c-med); animation: rotate 1s infinite linear; }
        .btn-icon.active-loc { background: var(--c-new); color: white; border: 2px solid white; }

        /* SEARCH BAR */
        .search-bar {
            background: white; border-radius: var(--radius-md); 
            box-shadow: var(--shadow-hard); display: flex; padding: 4px; gap: 4px; pointer-events: auto;
        }
        .search-input-group {
            flex: 1; display: flex; align-items: center; background: #f3f4f6;
            border-radius: 10px; padding: 0 12px; height: 44px;
        }
        .search-input-group input {
            border: none; background: transparent; width: 100%; height: 100%;
            font-family: var(--font-body); font-weight: 600; font-size: 14px; color: #333;
        }

        /* LOADER (NEW) */
        .loader-pill {
            align-self: center; background: rgba(0,0,0,0.8); color: white; padding: 8px 16px;
            border-radius: 20px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 8px;
            opacity: 0; transition: 0.3s; pointer-events: none; margin-top: 10px;
        }
        .loader-pill.visible { opacity: 1; }
        .spin { animation: rotate 1s infinite linear; }

        /* FABs */
        .fabs {
            position: absolute; bottom: 120px; right: 16px; 
            display: flex; flex-direction: column; gap: 12px; pointer-events: auto;
        }
        .fab-btn {
            width: 50px; height: 50px; border-radius: 18px; background: white;
            color: #1e293b; font-size: 18px; box-shadow: var(--shadow-hard);
            border: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center;
        }
        .fab-primary { background: var(--primary); color: white; }

        /* RESTAURANT MARKERS */
        .custom-pin {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 36px !important; height: 36px !important; 
            margin-left: -18px !important; margin-top: -18px !important;
            transition: transform 0.2s;
        }
        .custom-pin:hover { transform: scale(1.15); z-index: 5000 !important; }
        
        .pin-bubble {
            width: 100%; height: 100%; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 13px; color: white;
            border: 2px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .pin-bubble.high { background: var(--c-high); }
        .pin-bubble.med { background: var(--c-med); }
        .pin-bubble.low { background: var(--c-low); }
        .pin-bubble.unsaved { background: var(--c-new); color: white; }

        /* USER LOCATION (VAN) MARKER */
        .user-pin {
            display: flex; align-items: center; justify-content: center;
            width: 44px !important; height: 44px !important;
            margin-left: -22px !important; margin-top: -22px !important;
            background: var(--accent); border: 3px solid white; border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); color: white; font-size: 18px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(15, 23, 42, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(15, 23, 42, 0); } 100% { box-shadow: 0 0 0 0 rgba(15, 23, 42, 0); } }

        /* BANNER */
        .banner {
            position: absolute; bottom: 100px; left: 16px; right: 16px;
            background: white; border-radius: var(--radius-xl); padding: 16px;
            box-shadow: var(--shadow-hard); pointer-events: auto;
            display: flex; align-items: center; gap: 14px;
            transform: translateY(150%); transition: transform 0.3s;
        }
        .banner.active { transform: translateY(0); }
        .ban-img-wrap { width: 64px; height: 64px; border-radius: 16px; overflow: hidden; background: #eee; flex-shrink: 0; }
        .ban-img { width: 100%; height: 100%; object-fit: cover; }
        .ban-content { flex: 1; overflow: hidden; }
        .ban-title { font-weight: 800; font-size: 16px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ban-subtitle { font-size: 13px; color: #666; margin-bottom: 4px; }
        .ban-badge { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 6px; display: inline-block; }

        /* MODAL */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 5000;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            display: flex; align-items: flex-end; backdrop-filter: blur(4px);
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .sheet {
            width: 100%; max-width: 600px; margin: 0 auto; background: white;
            border-radius: 28px 28px 0 0; overflow: hidden; max-height: 90vh;
            transform: translateY(100%); transition: transform 0.3s ease;
            display: flex; flex-direction: column;
        }
        .modal-overlay.open .sheet { transform: translateY(0); }
        .sheet-body { padding: 24px; overflow-y: auto; }

        /* INPUTS */
        .modern-input {
            width: 100%; padding: 14px; background: #f8fafc; border: 1px solid #e2e8f0;
            border-radius: 12px; font-family: var(--font-body); font-weight: 500; font-size: 15px; margin-bottom: 12px;
        }
        .slider-row { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .slider-row span { width: 70px; font-size: 13px; font-weight: 700; color: #475569; }
        input[type=range] { flex: 1; -webkit-appearance: none; height: 10px; border-radius: 5px; background: #e2e8f0; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; border-radius: 50%; background: var(--primary); border: 2px solid white; cursor: pointer; }

        /* CREATION */
        .target-center { position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:500; display:none; pointer-events:none; }
        .target-center.visible { display:block; }
        .pin-target { width:40px; height:40px; background:var(--primary); border:4px solid white; border-radius:50% 50% 0 50%; transform:rotate(45deg); margin-top:-40px; box-shadow:0 10px 20px rgba(0,0,0,0.3); }
        .creation-ui { position:absolute; bottom:110px; left:0; right:0; text-align:center; display:none; pointer-events:auto; }
        .creation-ui.visible { display:block; }
        .btn-confirm { background:var(--primary); color:white; padding:12px 24px; border-radius:30px; border:none; font-weight:700; box-shadow:var(--shadow-hard); cursor: pointer; }

        /* LIST VIEW */
        .list-view {
            position: fixed; inset: 0; background: #f8fafc; z-index: 2000;
            transform: translateX(100%); transition: transform 0.3s;
            display: flex; flex-direction: column;
        }
        .list-view.open { transform: translateX(0); }
        .list-head { padding: 50px 20px 20px; background: white; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
        .list-body { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
        .list-card {
            background: white; border-radius: 16px; padding: 12px; margin-bottom: 12px;
            display: flex; gap: 12px; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            border: 1px solid #f1f5f9; cursor: pointer;
        }

        /* NAV */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0,0,0,0.05); padding-bottom: env(safe-area-inset-bottom);
            height: 80px; display: flex; justify-content: space-around; align-items: center; z-index: 3000;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #94a3b8; font-size: 10px; font-weight: 700; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 22px; }

        .toast { position: fixed; top: 120px; left: 50%; transform: translate(-50%, -20px); background: #333; color: white; padding: 10px 20px; border-radius: 30px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 6000; }
        .toast.visible { opacity: 1; transform: translate(-50%, 0); }
        @keyframes rotate { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="ui-layer">
        <!-- HEADER -->
        <div class="header-wrap">
            <div class="top-row">
                <div class="app-title"><i class="fa-solid fa-star"></i> Guide SIL</div>
                <button class="btn-icon" id="drive-btn" onclick="Drive.handleAuth()">
                    <i class="fa-brands fa-google-drive"></i>
                </button>
            </div>
            <!-- RECHERCHE & FILTRE -->
            <div class="search-bar">
                <div class="search-input-group">
                    <i class="fa-solid fa-map-pin" style="color:#999; margin-right:8px"></i>
                    <input type="text" id="inp-city" placeholder="Aller à une ville...">
                </div>
                <div style="width:1px; background:#ddd; margin:6px 0"></div>
                <div class="search-input-group">
                    <i class="fa-solid fa-filter" style="color:#999; margin-right:8px"></i>
                    <input type="text" id="inp-filter" placeholder="Filtrer nom..." oninput="App.applyFilters()">
                </div>
            </div>
            <!-- LOADER -->
            <div class="loader-pill" id="loader">
                <i class="fa-solid fa-circle-notch spin"></i> Recherche des restaurants...
            </div>
        </div>

        <!-- FABs -->
        <div class="fabs" id="main-ctrls">
            <button class="fab-btn fab-primary" onclick="App.startCreation()"><i class="fa-solid fa-plus"></i></button>
            <button class="fab-btn" id="btn-loc" onclick="App.toggleLocate()"><i class="fa-solid fa-location-arrow"></i></button>
        </div>

        <!-- BANNER -->
        <div class="banner" id="banner">
            <div class="ban-img-wrap"><img src="" class="ban-img" id="ban-img"></div>
            <div class="ban-content">
                <div class="ban-title" id="ban-title">...</div>
                <div class="ban-subtitle" id="ban-sub">...</div>
                <div class="ban-badge" id="ban-badge"></div>
            </div>
            <button class="btn-icon" style="width:36px; height:36px" onclick="App.openModal()"><i class="fa-solid fa-pen"></i></button>
        </div>

        <!-- CREATION -->
        <div class="target-center" id="target-marker"><div class="pin-target"></div></div>
        <div class="creation-ui" id="creation-ui">
            <button class="btn-confirm" onclick="App.confirmCreation()">VALIDER ICI</button>
            <div style="margin-top:10px"><button class="btn-icon" style="margin:0 auto; width:36px; height:36px" onclick="App.cancelCreation()"><i class="fa-solid fa-xmark"></i></button></div>
        </div>
    </div>

    <!-- LISTE -->
    <div class="list-view" id="list-view">
        <div class="list-head">
            <h2 style="margin:0; font-family:var(--font-display)">Mon Carnet</h2>
            <i class="fa-solid fa-xmark" style="font-size:24px; cursor:pointer" onclick="App.nav('map')"></i>
        </div>
        <div class="list-body" id="list-body"></div>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="modal">
        <div class="sheet">
            <div style="padding:20px; display:flex; justify-content:space-between; border-bottom:1px solid #eee">
                <h3 style="margin:0">Édition</h3>
                <i class="fa-solid fa-xmark" style="font-size:20px; cursor:pointer" onclick="App.closeModal()"></i>
            </div>
            <div class="sheet-body">
                <div onclick="document.getElementById('file').click()" style="text-align:center; margin-bottom:20px; cursor:pointer">
                    <img id="prev-img" style="width:100%; height:160px; object-fit:cover; border-radius:12px; background:#f1f5f9; display:none">
                    <div id="lbl-img" style="padding:30px; background:#f8fafc; border:2px dashed #cbd5e1; border-radius:12px; color:#94a3b8">
                        <i class="fa-solid fa-camera" style="font-size:24px"></i><br>PHOTO
                    </div>
                </div>
                <input type="file" id="file" hidden accept="image/*" onchange="App.handleImage(this)">

                <input type="text" class="modern-input" id="e-name" placeholder="Nom">
                <input type="text" class="modern-input" id="e-addr" placeholder="Adresse">

                <div style="display:flex; justify-content:space-between; margin:10px 0">
                    <span style="font-weight:700; font-size:12px; color:#999">NOTE</span>
                    <span id="score-display" style="font-weight:800; color:var(--primary)">0.0</span>
                </div>
                
                <div class="slider-row"><span>Goût</span><input type="range" min="0" max="10" step="0.5" id="r-taste" oninput="App.calc()"></div>
                <div class="slider-row"><span>Service</span><input type="range" min="0" max="10" step="0.5" id="r-qp" oninput="App.calc()"></div>
                <div class="slider-row"><span>Cadre</span><input type="range" min="0" max="10" step="0.5" id="r-vibe" oninput="App.calc()"></div>

                <div style="display:flex; gap:10px; margin-top:15px">
                    <input type="number" class="modern-input" id="p-min" placeholder="Min €">
                    <input type="number" class="modern-input" id="p-max" placeholder="Max €">
                </div>

                <button class="btn-confirm" style="width:100%; margin-top:10px" onclick="App.save()">ENREGISTRER</button>
                <button style="width:100%; background:transparent; border:none; color:var(--c-low); font-weight:600; padding:10px; margin-top:5px" onclick="App.remove()">Supprimer</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Msg</div>

    <!-- NAV -->
    <div class="nav-bar">
        <div class="nav-item active" id="nav-map" onclick="App.nav('map')"><i class="fa-solid fa-map"></i><span>Carte</span></div>
        <div class="nav-item" id="nav-list" onclick="App.nav('list')"><i class="fa-solid fa-book-open"></i><span>Carnet</span></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- GOOGLE DRIVE ---
        const Drive = (() => {
            const CLIENT_ID = "588180980452-0pparhgbk0vn7enus4kdo6ifqv61teaf.apps.googleusercontent.com";
            const SCOPES = 'https://www.googleapis.com/auth/drive.file';
            const FILE_NAME = "guide_michelin_sil_db.json";
            let tokenClient, token, fileId;

            const init = () => {
                if(typeof google === 'undefined') { setTimeout(init, 500); return; }
                try {
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID, scope: SCOPES, prompt: 'select_account',
                        callback: async (resp) => {
                            if(resp.error) { App.toast("Erreur Auth"); return; }
                            token = resp.access_token;
                            document.getElementById('drive-btn').classList.add('connected');
                            App.toast("Connecté ! Sync...");
                            await sync();
                        }
                    });
                } catch(e) {}
            };

            const handleAuth = () => {
                if(token) {
                    if(confirm("Déconnexion ?")) { token = null; document.getElementById('drive-btn').className='btn-icon'; }
                } else if(tokenClient) { tokenClient.requestAccessToken(); }
            };

            const getFileId = async () => {
                const q = `name='${FILE_NAME}' and trashed=false`;
                const r = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}`, { headers: { Authorization: `Bearer ${token}` } });
                const d = await r.json();
                if(d.files && d.files.length) return d.files[0].id;
                const meta = { name: FILE_NAME, mimeType: 'application/json' };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(meta)], {type:'application/json'}));
                form.append('file', new Blob([JSON.stringify([])], {type:'application/json'}));
                const cr = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', { method: 'POST', headers: { Authorization: `Bearer ${token}` }, body: form });
                return (await cr.json()).id;
            };

            const sync = async () => {
                if(!token) return;
                document.getElementById('drive-btn').classList.add('syncing');
                try {
                    if(!fileId) fileId = await getFileId();
                    const r = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, { headers: { Authorization: `Bearer ${token}` } });
                    const driveData = await r.json();
                    const localData = await App.getData();
                    let changed = false;
                    driveData.forEach(d => { if(!localData.find(l=>l.id===d.id)) { localData.push(d); changed = true; } });
                    if(changed) { await App.saveAll(localData); App.refresh(); }
                } catch(e) {}
                document.getElementById('drive-btn').classList.remove('syncing');
            };

            const save = async (data) => {
                if(!token) return;
                document.getElementById('drive-btn').classList.add('syncing');
                try {
                    if(!fileId) fileId = await getFileId();
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, { method: 'PATCH', headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                } catch(e) {}
                document.getElementById('drive-btn').classList.remove('syncing');
            };

            return { init, handleAuth, save, sync };
        })();

        // --- APP ENGINE ---
        const App = (() => {
            let map, db;
            let markers = [];
            let allPlaces = [], savedPlaces = [];
            let selectedPlace = null;
            let currentImg = null;
            let isCreating = false;
            let isLocating = false;
            let userMarker = null;
            
            const DEF_IMG = "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400&q=80";

            const init = async () => {
                try {
                    initMap();
                    await initDB();
                    await loadSaved();
                    updateMap();
                    document.getElementById('inp-city').addEventListener('change', e => searchCity(e.target.value));
                    Drive.init();
                } catch(e) { console.error(e); }
            };

            const initDB = () => new Promise(r => {
                const req = indexedDB.open('GuideSil_V29', 1);
                req.onupgradeneeded = e => e.target.result.createObjectStore('places', {keyPath: 'id'});
                req.onsuccess = e => { db = e.target.result; r(); };
            });
            const loadSaved = () => new Promise(r => {
                if(!db) return r();
                db.transaction('places', 'readonly').objectStore('places').getAll().onsuccess = e => { savedPlaces = e.target.result || []; r(); };
            });
            const getData = () => new Promise(r => r(savedPlaces));
            const saveAll = (data) => new Promise(r => {
                const tx = db.transaction('places', 'readwrite');
                data.forEach(d => tx.objectStore('places').put(d));
                tx.oncomplete = () => { savedPlaces = data; r(); };
            });

            // MAP & SCANNER
            const initMap = () => {
                map = L.map('map', {zoomControl: false, attributionControl: false}).setView([48.8566, 2.3522], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(map);
                
                // Scan on move (if not creating)
                map.on('moveend', () => { 
                    if(isLocating) return; // Don't scan randomly if tracking user
                    if(!isCreating && map.getZoom() > 13) scan(); 
                });
                
                // Stop location tracking if user drags
                map.on('dragstart', () => {
                    if(isLocating) { isLocating = false; document.getElementById('btn-loc').classList.remove('active-loc'); }
                });
                
                setTimeout(scan, 1000);
            };

            const scan = async (centerOverride) => {
                // Buffer 50% around screen (0.5 padding)
                const b = map.getBounds().pad(0.5); 
                const q = `[out:json][timeout:5];node["amenity"~"restaurant|bar|cafe"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});out 40;`;
                
                const loader = document.getElementById('loader');
                loader.classList.add('visible');
                
                try {
                    const r = await fetch('https://overpass-api.de/api/interpreter', {method:'POST', body:q});
                    const d = await r.json();
                    const newP = d.elements.map(e => ({
                        id: e.id, name: e.tags.name || "Inconnu",
                        addr: (e.tags['addr:street']||"")+" "+(e.tags['addr:city']||""),
                        lat: e.lat, lon: e.lon
                    }));
                    
                    allPlaces = [...savedPlaces];
                    newP.forEach(n => { if(!savedPlaces.find(s=>s.id===n.id)) allPlaces.push(n); });
                    updateMap();
                } catch(e){}
                
                loader.classList.remove('visible');
            };

            const updateMap = () => {
                markers.forEach(m => map.removeLayer(m.marker));
                markers = [];
                applyFilters();
            };

            const applyFilters = () => {
                const term = document.getElementById('inp-filter').value.toLowerCase();
                markers.forEach(m => map.removeLayer(m.marker));
                markers = [];

                allPlaces.forEach(p => {
                    const isSaved = savedPlaces.find(s=>s.id===p.id);
                    const match = !term || (p.name && p.name.toLowerCase().includes(term));
                    
                    let html;
                    if(isSaved) {
                        const score = p.score?.total || 0;
                        let bubble = 'med';
                        if(score >= 8) bubble = 'high';
                        if(score < 5) bubble = 'low';
                        html = `<div class="pin-bubble ${bubble}">${score}</div>`;
                    } else {
                        html = `<div class="pin-bubble unsaved"><i class="fa-solid fa-utensils"></i></div>`;
                    }
                    
                    let opacity = match ? 1 : 0.2; 
                    if(match || isSaved) {
                        const m = L.marker([p.lat, p.lon], {
                            icon: L.divIcon({className: 'custom-pin', html: html}),
                            opacity: opacity,
                            zIndexOffset: isSaved ? 1000 : 0
                        }).addTo(map);
                        m.on('click', () => { if(match) select(p, isSaved); });
                        markers.push({marker:m});
                    }
                });
            };

            const select = (p, saved) => {
                selectedPlace = saved || p;
                map.flyTo([p.lat - 0.002, p.lon], 16);
                
                document.getElementById('ban-title').innerText = p.name || "Inconnu";
                document.getElementById('ban-sub').innerText = p.addr || "Lieu détecté";
                
                const badge = document.getElementById('ban-badge');
                if(selectedPlace.score?.total) {
                    const s = selectedPlace.score.total;
                    badge.innerText = `Note: ${s}/10`;
                    badge.style.color = s>=8 ? 'var(--c-high)' : (s>=5 ? 'var(--c-med)' : 'var(--c-low)');
                    badge.style.background = "#eee";
                } else {
                    badge.innerText = "Non enregistré";
                    badge.style.color = "#fff";
                    badge.style.background = "var(--c-new)";
                }
                
                document.getElementById('ban-img').src = selectedPlace.img || DEF_IMG;
                document.getElementById('banner').classList.add('active');
            };

            // GEOLOCATION (VAN)
            const toggleLocate = () => {
                if(isLocating) {
                    // Turn off
                    isLocating = false;
                    document.getElementById('btn-loc').classList.remove('active-loc');
                } else {
                    // Turn on
                    isLocating = true;
                    document.getElementById('btn-loc').classList.add('active-loc');
                    
                    navigator.geolocation.getCurrentPosition(p => {
                        const lat = p.coords.latitude;
                        const lon = p.coords.longitude;
                        
                        // Center Map
                        map.setView([lat, lon], 16);
                        
                        // User Marker (Van)
                        if(userMarker) map.removeLayer(userMarker);
                        const vanHtml = `<div class="user-pin"><i class="fa-solid fa-truck-fast"></i></div>`;
                        userMarker = L.marker([lat, lon], {
                            icon: L.divIcon({ className: 'van-wrap', html: vanHtml, iconSize:[40,40] }),
                            zIndexOffset: 2000
                        }).addTo(map);

                        // Immediate Scan
                        scan();
                        
                    }, err => { alert("Position impossible"); isLocating = false; });
                }
            };

            // ACTIONS
            const startCreation = () => { isCreating=true; document.getElementById('main-ctrls').style.display='none'; document.getElementById('banner').classList.remove('active'); document.getElementById('target-marker').classList.add('visible'); document.getElementById('creation-ui').classList.add('visible'); };
            const cancelCreation = () => { isCreating=false; document.getElementById('main-ctrls').style.display='flex'; document.getElementById('target-marker').classList.remove('visible'); document.getElementById('creation-ui').classList.remove('visible'); };
            const confirmCreation = () => {
                const c = map.getCenter();
                const newP = { id:Date.now(), name:"", addr:"Position", lat:c.lat, lon:c.lng, score:{qp:5, taste:5, vibe:5, total:5}, img:null, price:{min:'', max:''} };
                cancelCreation(); savedPlaces.push(newP); select(newP, newP); openModal();
            };

            const openModal = () => {
                const p = selectedPlace;
                document.getElementById('e-name').value = p.name||"";
                document.getElementById('e-addr').value = p.addr||"";
                const s = p.score || {qp:5, taste:5, vibe:5};
                document.getElementById('r-taste').value = s.taste; document.getElementById('r-qp').value = s.qp; document.getElementById('r-vibe').value = s.vibe;
                document.getElementById('p-min').value = p.price?.min||""; document.getElementById('p-max').value = p.price?.max||"";
                
                currentImg = p.img;
                if(currentImg) { document.getElementById('prev-img').src=currentImg; document.getElementById('prev-img').style.display='block'; document.getElementById('lbl-img').style.display='none'; }
                else { document.getElementById('prev-img').style.display='none'; document.getElementById('lbl-img').style.display='block'; }
                
                calc(); document.getElementById('modal').classList.add('open');
            };
            const closeModal = () => document.getElementById('modal').classList.remove('open');
            
            const calc = () => {
                const t=parseFloat(document.getElementById('r-taste').value), q=parseFloat(document.getElementById('r-qp').value), v=parseFloat(document.getElementById('r-vibe').value);
                const tot=((t+q+v)/3).toFixed(1); document.getElementById('score-display').innerText=tot;
                return {taste:t, qp:q, vibe:v, total:tot};
            };
            
            const handleImage = (i) => { if(i.files[0]){ const r=new FileReader(); r.onload=e=>{ currentImg=e.target.result; document.getElementById('prev-img').src=currentImg; document.getElementById('prev-img').style.display='block'; document.getElementById('lbl-img').style.display='none'; }; r.readAsDataURL(i.files[0]); }};
            
            const save = () => {
                const u = { ...selectedPlace, name:document.getElementById('e-name').value, addr:document.getElementById('e-addr').value, score:calc(), price:{min:document.getElementById('p-min').value, max:document.getElementById('p-max').value}, img:currentImg };
                const idx = savedPlaces.findIndex(x=>x.id===u.id); if(idx>-1) savedPlaces[idx]=u; else savedPlaces.push(u);
                const tx = db.transaction('places', 'readwrite'); tx.objectStore('places').put(u);
                closeModal(); updateMap(); select(u,u); Drive.save(savedPlaces); toast("Enregistré");
            };
            
            const remove = () => {
                if(!confirm("Supprimer ?")) return;
                db.transaction('places', 'readwrite').objectStore('places').delete(selectedPlace.id);
                savedPlaces = savedPlaces.filter(x=>x.id!==selectedPlace.id);
                closeModal(); document.getElementById('banner').classList.remove('active'); updateMap(); Drive.save(savedPlaces); toast("Supprimé");
            };

            const nav = (v) => {
                document.getElementById('nav-map').classList.toggle('active', v==='map'); document.getElementById('nav-list').classList.toggle('active', v==='list');
                const lv=document.getElementById('list-view'); if(v==='list'){ renderList(); lv.classList.add('open'); } else lv.classList.remove('open');
            };

            const renderList = () => {
                const c=document.getElementById('list-body');
                if(!savedPlaces.length) { c.innerHTML='<div style="text-align:center;color:#999;padding:40px">Vide</div>'; return; }
                const grps={}; savedPlaces.forEach(p=>{
                    let city="DIVERS"; if(p.addr){ const pt=p.addr.toUpperCase().split(' '); const i=pt.findIndex(x=>/^\d{5}$/.test(x)); if(i>-1 && pt[i+1]) city=pt[i+1]; }
                    if(!grps[city]) grps[city]=[]; grps[city].push(p);
                });
                c.innerHTML=Object.keys(grps).sort().map(city=>`
                    <div style="margin-bottom:20px"><div style="font-weight:700;color:var(--primary);margin-bottom:10px">${city}</div>
                    ${grps[city].map(p=>`
                        <div class="list-card" onclick="App.goto(${p.id})">
                            <img src="${p.img||DEF_IMG}" style="width:60px;height:60px;object-fit:cover;border-radius:8px">
                            <div style="flex:1">
                                <div style="font-weight:700">${p.name}</div>
                                <div style="font-size:12px;color:#666">${p.addr.substring(0,25)}...</div>
                                <div style="font-size:11px;font-weight:700;color:var(--primary)">${p.score?.total||'-'}/10</div>
                            </div>
                        </div>`).join('')}
                    </div>`).join('');
            };
            
            const goto = (id) => { nav('map'); const p=savedPlaces.find(x=>x.id===id); if(p) setTimeout(()=>select(p,p),300); };
            const searchCity = async (v) => { if(v.length<3)return; const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${v}&limit=1`); const d=await r.json(); if(d.length) map.setView([d[0].lat, d[0].lon], 13); };
            
            const toast = (m) => { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('visible'); setTimeout(()=>t.classList.remove('visible'),2500); };
            const refresh = () => { updateMap(); toast("Sync OK"); };

            return { init, getData, saveAll, refresh, startCreation, cancelCreation, confirmCreation, openModal, closeModal, save, remove, handleImage, calc, nav, applyFilters, toggleLocate, goto, toast };
        })();

        window.Drive = Drive;
        window.App = App;
        window.onload = App.init;
    </script>
</body>
</html>
