<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Guide Michelin SIL - Premium</title>
    
    <!-- 1. FONTS & ICONS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 2. LEAFLET + CLUSTER CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <!-- 3. GOOGLE AUTH -->
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <style>
        /* --- DESIGN SYSTEM (Airbnb / Apple Maps vibe) --- */
        :root {
            --primary: #E11D48; /* Rouge moderne, moins agressif */
            --accent: #0F172A;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --bg-glass: rgba(255, 255, 255, 0.85);
            --border-glass: rgba(255, 255, 255, 0.6);
            --shadow-soft: 0 8px 30px rgba(0, 0, 0, 0.08);
            --shadow-hard: 0 4px 12px rgba(0, 0, 0, 0.15);
            --radius-xl: 24px;
            --radius-md: 14px;
            --font-body: 'Inter', sans-serif;
            --font-display: 'Playfair Display', serif;
            --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; width: 100%; height: 100dvh; font-family: var(--font-body); background: #f2f2f2; overflow: hidden; color: var(--accent); }

        /* --- UTILS --- */
        .glass {
            background: var(--bg-glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-glass);
        }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .hidden { display: none !important; }

        /* --- MAP LAYER --- */
        #map { position: absolute; inset: 0; z-index: 0; background: #e5e5e5; }
        
        /* Marker Cluster Customization */
        .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
            background-color: rgba(225, 29, 72, 0.2);
        }
        .marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div {
            background-color: var(--primary);
            color: white;
            font-weight: 700;
            font-family: var(--font-body);
        }

        /* --- UI LAYER --- */
        .ui-layer {
            position: absolute; inset: 0; z-index: 1000; pointer-events: none;
            display: flex; flex-direction: column;
        }
        .pointer { pointer-events: auto; }

        /* HEADER */
        .header-wrap {
            padding: max(10px, env(safe-area-inset-top)) 16px 10px;
            display: flex; flex-direction: column; gap: 12px;
            pointer-events: none;
        }

        .top-row {
            display: flex; justify-content: space-between; align-items: center;
            pointer-events: none;
        }
        
        .app-title {
            font-family: var(--font-display); font-size: 20px; font-weight: 800; color: var(--primary);
            background: white; padding: 6px 16px; border-radius: 30px; 
            box-shadow: var(--shadow-hard); display: flex; align-items: center; gap: 8px;
        }

        /* BTN DRIVE */
        .btn-icon {
            width: 44px; height: 44px; border-radius: 50%; background: white; border: none;
            color: #333; font-size: 18px; box-shadow: var(--shadow-hard);
            transition: transform 0.1s; cursor: pointer;
        }
        .btn-icon:active { transform: scale(0.92); }
        .btn-icon.connected { color: var(--success); border: 2px solid var(--success); }
        .btn-icon.syncing { color: var(--warning); border: 2px solid var(--warning); animation: rotate 1s infinite linear; }

        /* SEARCH BAR */
        .search-bar {
            background: white; border-radius: var(--radius-md); 
            box-shadow: var(--shadow-hard); display: flex; padding: 4px; gap: 4px;
            pointer-events: auto;
        }
        .search-input-group {
            flex: 1; display: flex; align-items: center; background: #f3f4f6;
            border-radius: 10px; padding: 0 12px; height: 44px;
        }
        .search-input-group input {
            border: none; background: transparent; width: 100%; height: 100%;
            font-family: var(--font-body); font-weight: 500; font-size: 14px;
        }
        .search-divider { width: 1px; background: #ddd; margin: 6px 0; }

        /* FABs */
        .fabs {
            position: absolute; bottom: 120px; right: 16px; 
            display: flex; flex-direction: column; gap: 12px; pointer-events: auto;
        }
        .fab-btn {
            width: 50px; height: 50px; border-radius: 18px; background: white;
            color: #1e293b; font-size: 18px; box-shadow: var(--shadow-soft);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .fab-primary { background: var(--primary); color: white; box-shadow: 0 8px 25px rgba(225, 29, 72, 0.4); }

        /* BANNER (Bottom Card) */
        .banner {
            position: absolute; bottom: 100px; left: 16px; right: 16px;
            background: white; border-radius: var(--radius-xl); padding: 16px;
            box-shadow: var(--shadow-soft); pointer-events: auto;
            display: flex; align-items: center; gap: 14px;
            transform: translateY(120%); transition: transform 0.4s var(--ease-bounce);
        }
        .banner.active { transform: translateY(0); }
        
        .ban-img-wrap {
            width: 64px; height: 64px; border-radius: 16px; overflow: hidden; flex-shrink: 0;
            background: #f0f0f0; position: relative;
        }
        .ban-img { width: 100%; height: 100%; object-fit: cover; }
        .ban-content { flex: 1; min-width: 0; }
        .ban-title { font-weight: 800; font-size: 17px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ban-subtitle { font-size: 13px; color: #64748b; margin-bottom: 6px; }
        .ban-badge {
            display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px;
            border-radius: 6px; font-size: 11px; font-weight: 700; background: #f1f5f9; color: #475569;
        }
        .ban-badge.high { background: #dcfce7; color: #166534; }
        .ban-badge.med { background: #fef3c7; color: #92400e; }

        /* TARGET (Add Mode) */
        .target-center {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 500; pointer-events: none; opacity: 0; transition: opacity 0.2s;
        }
        .target-center.visible { opacity: 1; }
        .pin-target {
            width: 40px; height: 40px; background: var(--primary);
            border: 4px solid white; border-radius: 50% 50% 0 50%;
            transform: rotate(45deg); box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            margin-top: -40px; /* Tip on center */
        }

        .creation-toolbar {
            position: absolute; bottom: 40px; left: 0; right: 0;
            display: flex; justify-content: center; gap: 16px;
            transform: translateY(100px); transition: 0.3s;
            pointer-events: auto;
        }
        .creation-toolbar.visible { transform: translateY(0); }
        .btn-pill {
            padding: 12px 24px; border-radius: 100px; font-weight: 600; font-size: 14px;
            border: none; box-shadow: var(--shadow-hard); cursor: pointer;
        }
        .btn-cancel { background: white; color: #64748b; }
        .btn-confirm { background: var(--primary); color: white; }

        /* --- LIST VIEW --- */
        .list-view {
            position: fixed; inset: 0; background: #f8fafc; z-index: 2000;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column;
        }
        .list-view.open { transform: translateX(0); }

        .list-header {
            padding: 60px 20px 10px; background: white; border-bottom: 1px solid #f1f5f9;
        }
        .list-title { font-family: var(--font-display); font-size: 28px; margin: 0 0 16px 0; }
        
        /* CHIPS FILTERS */
        .chips-scroll {
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px;
            scrollbar-width: none;
        }
        .chips-scroll::-webkit-scrollbar { display: none; }
        .chip {
            padding: 6px 14px; border-radius: 20px; background: #f1f5f9; color: #475569;
            font-size: 13px; font-weight: 600; white-space: nowrap; transition: 0.2s; border: 1px solid transparent;
        }
        .chip.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(225,29,72,0.3); }

        .list-body { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
        .list-group-title {
            font-size: 12px; font-weight: 700; text-transform: uppercase; color: #94a3b8;
            margin-bottom: 10px; letter-spacing: 0.5px; position: sticky; top: 0;
        }
        .list-card {
            background: white; border-radius: 16px; padding: 12px; margin-bottom: 12px;
            display: flex; gap: 12px; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            border: 1px solid #f1f5f9; transition: transform 0.1s;
        }
        .list-card:active { transform: scale(0.98); }

        /* --- MODAL (Bottom Sheet) --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 5000;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            display: flex; align-items: flex-end; backdrop-filter: blur(4px);
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .sheet {
            width: 100%; max-width: 600px; margin: 0 auto; background: white;
            border-radius: 28px 28px 0 0; overflow: hidden; max-height: 90vh;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
            display: flex; flex-direction: column;
        }
        .modal-overlay.open .sheet { transform: translateY(0); }

        .sheet-head {
            padding: 20px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #f1f5f9; background: white; z-index: 10;
        }
        .sheet-body { padding: 24px; overflow-y: auto; }

        /* Modern Inputs */
        .input-group { margin-bottom: 20px; }
        .input-label { display: block; font-size: 11px; font-weight: 700; color: #64748b; margin-bottom: 8px; text-transform: uppercase; }
        .modern-input {
            width: 100%; padding: 14px; background: #f8fafc; border: 1px solid #e2e8f0;
            border-radius: 12px; font-family: var(--font-body); font-weight: 500; font-size: 15px; color: #0f172a;
        }
        .modern-input:focus { border-color: var(--primary); background: white; }

        /* Range Sliders Custom */
        .sliders-grid { display: grid; gap: 12px; }
        .slider-row { display: flex; align-items: center; gap: 10px; }
        .slider-row span { width: 80px; font-size: 13px; font-weight: 600; color: #334155; }
        input[type=range] {
            flex: 1; height: 6px; border-radius: 3px; background: #e2e8f0; outline: none; -webkit-appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%;
            background: var(--primary); box-shadow: 0 2px 6px rgba(225, 29, 72, 0.4); border: 2px solid white;
        }

        /* --- BOTTOM NAV --- */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-glass);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-glass); padding-bottom: env(safe-area-inset-bottom);
            height: 80px; display: flex; justify-content: space-around; align-items: center; z-index: 3000;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            color: #94a3b8; transition: 0.2s; cursor: pointer;
        }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-item i { font-size: 22px; }
        .nav-item span { font-size: 10px; font-weight: 700; }

        /* CUSTOM MARKER CSS */
        .custom-pin {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 34px !important; height: 34px !important; 
            margin-left: -17px !important; margin-top: -17px !important; /* Centering */
            transition: transform 0.2s;
        }
        .custom-pin:hover { transform: scale(1.1); z-index: 1000 !important; }
        
        /* Note bubble inside marker */
        .pin-bubble {
            width: 32px; height: 32px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 12px; color: white;
            border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .pin-bubble.high { background: var(--success); }
        .pin-bubble.med { background: var(--warning); }
        .pin-bubble.low { background: var(--danger); }
        .pin-bubble.unsaved { background: white; color: #333; border: 2px solid #ccc; font-size: 0; } /* Empty bubble for unsaved */
        .pin-bubble.unsaved::after { content:'\f2e7'; font-family:'Font Awesome 6 Free'; font-weight:900; font-size:14px; color:#ccc; }

        /* Toast */
        .toast {
            position: fixed; top: 120px; left: 50%; transform: translate(-50%, -20px);
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px);
            color: white; padding: 10px 20px; border-radius: 30px; font-size: 13px; font-weight: 600;
            opacity: 0; pointer-events: none; transition: 0.3s; z-index: 6000;
        }
        .toast.visible { opacity: 1; transform: translate(-50%, 0); }

        @keyframes rotate { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- MAP CONTAINER -->
    <div id="map"></div>

    <!-- UI LAYER -->
    <div class="ui-layer">
        
        <!-- TOP HEADER -->
        <div class="header-wrap">
            <div class="top-row pointer">
                <div class="app-title"><i class="fa-solid fa-star"></i> Guide SIL</div>
                <button class="btn-icon flex-center" id="drive-btn" onclick="Drive.handleAuth()">
                    <i class="fa-brands fa-google-drive"></i>
                </button>
            </div>
            
            <div class="search-bar">
                <div class="search-input-group">
                    <i class="fa-solid fa-location-dot" style="color:#94a3b8; margin-right:8px"></i>
                    <input type="text" id="inp-city" placeholder="Aller à...">
                </div>
                <div class="search-divider"></div>
                <div class="search-input-group">
                    <i class="fa-solid fa-magnifying-glass" style="color:#94a3b8; margin-right:8px"></i>
                    <input type="text" id="inp-filter" placeholder="Filtrer..." oninput="App.applyFilters()">
                </div>
            </div>
        </div>

        <!-- RIGHT CONTROLS -->
        <div class="fabs" id="main-ctrls">
            <button class="fab-btn fab-primary flex-center" onclick="App.startCreation()">
                <i class="fa-solid fa-plus"></i>
            </button>
            <button class="fab-btn flex-center" onclick="App.locate()">
                <i class="fa-solid fa-crosshairs"></i>
            </button>
        </div>

        <!-- BANNER INFO -->
        <div class="banner" id="banner">
            <div class="ban-img-wrap">
                <img src="" class="ban-img" id="ban-img">
            </div>
            <div class="ban-content">
                <div class="ban-title" id="ban-title">Nom du lieu</div>
                <div class="ban-subtitle" id="ban-sub">Adresse courte</div>
                <div class="ban-badge" id="ban-badge">Note</div>
            </div>
            <button class="btn-icon flex-center" onclick="App.openModal()">
                <i class="fa-solid fa-pen"></i>
            </button>
        </div>

        <!-- CREATION HUD -->
        <div class="target-center" id="target-marker">
            <div class="pin-target"></div>
        </div>
        <div class="creation-toolbar" id="creation-ui">
            <button class="btn-pill btn-cancel" onclick="App.cancelCreation()">Annuler</button>
            <button class="btn-pill btn-confirm" onclick="App.confirmCreation()">Valider cette position</button>
        </div>

    </div>

    <!-- VIEW: LIST -->
    <div class="list-view" id="list-view">
        <div class="list-header">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h2 class="list-title">Mon Carnet</h2>
                <i class="fa-solid fa-xmark" style="font-size:24px; color:#94a3b8; cursor:pointer" onclick="App.nav('map')"></i>
            </div>
            <!-- CHIPS -->
            <div class="chips-scroll" id="chips-container">
                <div class="chip active" onclick="App.filterList('all', this)">Tout</div>
                <div class="chip" onclick="App.filterList('top', this)">Top Chefs (>8)</div>
                <div class="chip" onclick="App.filterList('cheap', this)">Budget €</div>
                <div class="chip" onclick="App.filterList('photos', this)">Avec photos</div>
            </div>
        </div>
        <div class="list-body" id="list-body">
            <!-- Items generated here -->
        </div>
    </div>

    <!-- MODAL EDIT -->
    <div class="modal-overlay" id="modal">
        <div class="sheet">
            <div class="sheet-head">
                <h3 style="margin:0; font-family:var(--font-display)">Détails</h3>
                <button class="btn-icon" style="width:32px; height:32px; box-shadow:none; background:#f1f5f9" onclick="App.closeModal()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="sheet-body">
                <!-- PHOTO UPLOAD -->
                <div onclick="document.getElementById('file').click()" style="margin-bottom:24px; text-align:center; cursor:pointer">
                    <img id="prev-img" style="width:100%; height:180px; object-fit:cover; border-radius:16px; background:#f1f5f9; display:none">
                    <div id="lbl-img" style="padding:40px; background:#f8fafc; border:2px dashed #cbd5e1; border-radius:16px; color:#94a3b8">
                        <i class="fa-solid fa-camera" style="font-size:28px; margin-bottom:8px"></i><br>
                        <span style="font-size:12px; font-weight:600">AJOUTER UNE PHOTO</span>
                    </div>
                </div>
                <input type="file" id="file" hidden accept="image/*" onchange="App.handleImage(this)">

                <div class="input-group">
                    <label class="input-label">Informations</label>
                    <input type="text" class="modern-input" id="e-name" placeholder="Nom du restaurant" style="margin-bottom:10px">
                    <input type="text" class="modern-input" id="e-addr" placeholder="Adresse complète">
                </div>

                <div class="input-group">
                    <label class="input-label" style="display:flex; justify-content:space-between">
                        <span>Notes</span>
                        <span id="score-display" style="color:var(--primary); font-size:14px">0.0</span>
                    </label>
                    <div class="sliders-grid">
                        <div class="slider-row"><span>Cuisine</span><input type="range" min="0" max="10" step="0.5" id="r-taste" oninput="App.calc()"></div>
                        <div class="slider-row"><span>Service</span><input type="range" min="0" max="10" step="0.5" id="r-qp" oninput="App.calc()"></div>
                        <div class="slider-row"><span>Cadre</span><input type="range" min="0" max="10" step="0.5" id="r-vibe" oninput="App.calc()"></div>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Budget (€)</label>
                    <div style="display:flex; gap:12px">
                        <input type="number" class="modern-input" id="p-min" placeholder="Min">
                        <input type="number" class="modern-input" id="p-max" placeholder="Max">
                    </div>
                </div>

                <button class="btn-pill" style="width:100%; background:var(--primary); color:white; margin-top:10px" onclick="App.save()">ENREGISTRER</button>
                <button class="btn-pill" style="width:100%; background:transparent; color:var(--danger); box-shadow:none; margin-top:8px" onclick="App.remove()">Supprimer ce lieu</button>
            </div>
        </div>
    </div>

    <!-- TOAST MSG -->
    <div class="toast" id="toast">Message</div>

    <!-- NAVIGATION BAR -->
    <div class="nav-bar">
        <div class="nav-item active" id="nav-map" onclick="App.nav('map')">
            <i class="fa-solid fa-map"></i>
            <span>Explorer</span>
        </div>
        <div class="nav-item" id="nav-list" onclick="App.nav('list')">
            <i class="fa-solid fa-book-bookmark"></i>
            <span>Carnet</span>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <script>
        // --- GOOGLE DRIVE MODULE (PRESERVED) ---
        const Drive = (() => {
            const CLIENT_ID = "588180980452-0pparhgbk0vn7enus4kdo6ifqv61teaf.apps.googleusercontent.com";
            const SCOPES = 'https://www.googleapis.com/auth/drive.file';
            const FILE_NAME = "guide_michelin_sil_v3.json";
            
            let tokenClient, token;
            let fileId = null;

            const init = () => {
                if(typeof google === 'undefined') return setTimeout(init, 500);
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID, scope: SCOPES, prompt: 'select_account',
                    callback: async (resp) => {
                        if(resp.error) return App.toast("Erreur Auth");
                        token = resp.access_token;
                        document.getElementById('drive-btn').classList.add('connected');
                        App.toast("Connecté Drive ! Sync...");
                        await sync();
                    }
                });
            };

            const handleAuth = () => {
                if(token) { if(confirm("Déconnexion ?")) { token = null; document.getElementById('drive-btn').className='btn-icon flex-center'; } }
                else if(tokenClient) tokenClient.requestAccessToken();
            };

            const getFileId = async () => {
                const q = `name='${FILE_NAME}' and trashed=false`;
                const r = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}`, { headers: { Authorization: `Bearer ${token}` } });
                const d = await r.json();
                if(d.files?.length) return d.files[0].id;
                const meta = { name: FILE_NAME, mimeType: 'application/json' };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(meta)], {type:'application/json'}));
                form.append('file', new Blob([JSON.stringify([])], {type:'application/json'}));
                const cr = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', { method: 'POST', headers: { Authorization: `Bearer ${token}` }, body: form });
                return (await cr.json()).id;
            };

            const sync = async () => {
                if(!token) return;
                document.getElementById('drive-btn').classList.add('syncing');
                try {
                    if(!fileId) fileId = await getFileId();
                    const r = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, { headers: { Authorization: `Bearer ${token}` } });
                    const driveData = await r.json();
                    const localData = await App.getData();
                    let changed = false;
                    driveData.forEach(d => { if(!localData.find(l=>l.id===d.id)) { localData.push(d); changed = true; } });
                    if(changed) { await App.saveAll(localData); App.refresh(); }
                } catch(e){}
                document.getElementById('drive-btn').classList.remove('syncing');
            };

            const save = async (data) => {
                if(!token) return;
                document.getElementById('drive-btn').classList.add('syncing');
                try {
                    if(!fileId) fileId = await getFileId();
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, { method: 'PATCH', headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                } catch(e){}
                document.getElementById('drive-btn').classList.remove('syncing');
            };

            return { init, handleAuth, save, sync };
        })();

        // --- APPLICATION LOGIC ---
        const App = (() => {
            let map, db, clusterGroup;
            let allPlaces = [], savedPlaces = [];
            let selectedPlace = null;
            let currentImg = null;
            
            const DEF_IMG = "https://images.unsplash.com/photo-1552566626-52f8b828add9?auto=format&fit=crop&w=400&q=80";

            // Init
            const init = async () => {
                initMap();
                await initDB();
                await loadSaved();
                updateMap(); // Load markers
                Drive.init();
                
                document.getElementById('inp-city').addEventListener('change', e => searchCity(e.target.value));
            };

            const initDB = () => new Promise(r => {
                const req = indexedDB.open('GuidePremium_v1', 1);
                req.onupgradeneeded = e => e.target.result.createObjectStore('places', {keyPath: 'id'});
                req.onsuccess = e => { db = e.target.result; r(); };
            });

            const loadSaved = () => new Promise(r => {
                db.transaction('places', 'readonly').objectStore('places').getAll().onsuccess = e => {
                    savedPlaces = e.target.result || [];
                    r();
                };
            });
            const getData = () => new Promise(r => r(savedPlaces));
            const saveAll = (data) => new Promise(r => {
                const tx = db.transaction('places', 'readwrite');
                data.forEach(d => tx.objectStore('places').put(d));
                tx.oncomplete = () => { savedPlaces = data; r(); };
            });

            // Map & Clusters
            const initMap = () => {
                map = L.map('map', {zoomControl: false, attributionControl: false}).setView([48.8566, 2.3522], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
                
                // Initialize Cluster Group
                clusterGroup = L.markerClusterGroup({
                    showCoverageOnHover: false,
                    maxClusterRadius: 35,
                    iconCreateFunction: function(cluster) {
                        return L.divIcon({ 
                            html: `<div>${cluster.getChildCount()}</div>`, 
                            className: 'marker-cluster marker-cluster-small', 
                            iconSize: new L.Point(40, 40) 
                        });
                    }
                });
                map.addLayer(clusterGroup);

                map.on('moveend', () => { if(map.getZoom()>13 && document.getElementById('creation-ui').classList.contains('hidden')) scan(); });
            };

            const scan = async () => {
                // Fetch from Overpass if needed (only if few saved places in view)
                // Simplified for this demo: only map saved items for performance/cleanliness 
                // but you can uncomment overpass logic if desired.
            };

            const updateMap = () => {
                clusterGroup.clearLayers();
                const term = document.getElementById('inp-filter').value.toLowerCase();
                
                savedPlaces.forEach(p => {
                    if(term && !p.name.toLowerCase().includes(term)) return;

                    const score = p.score?.total || 0;
                    // Define visuals
                    let colorClass = 'med';
                    if(score >= 8) colorClass = 'high';
                    if(score < 5) colorClass = 'low';
                    
                    const html = `<div class="pin-bubble ${colorClass}">${score}</div>`;
                    
                    const marker = L.marker([p.lat, p.lon], {
                        icon: L.divIcon({ className: 'custom-pin', html: html })
                    });
                    
                    marker.on('click', () => select(p));
                    clusterGroup.addLayer(marker);
                });
            };

            // Interactions
            const select = (p) => {
                selectedPlace = p;
                map.flyTo([p.lat - 0.002, p.lon], 16); // Slight offset for bottom sheet
                
                document.getElementById('ban-title').innerText = p.name || "Sans nom";
                document.getElementById('ban-sub').innerText = p.addr || "Position GPS";
                
                const s = p.score?.total;
                const badge = document.getElementById('ban-badge');
                if(s) {
                    badge.innerText = `Note: ${s}/10`;
                    badge.className = `ban-badge ${s>=8?'high':(s>=5?'med':'')}`;
                } else {
                    badge.innerText = "Nouveau";
                    badge.className = "ban-badge";
                }
                
                document.getElementById('ban-img').src = p.img || DEF_IMG;
                document.getElementById('banner').classList.add('active');
            };

            // Modes
            const startCreation = () => {
                document.getElementById('main-ctrls').style.display = 'none';
                document.getElementById('banner').classList.remove('active');
                document.getElementById('target-marker').classList.add('visible');
                document.getElementById('creation-ui').classList.add('visible');
            };

            const cancelCreation = () => {
                document.getElementById('main-ctrls').style.display = 'flex';
                document.getElementById('target-marker').classList.remove('visible');
                document.getElementById('creation-ui').classList.remove('visible');
            };

            const confirmCreation = () => {
                const c = map.getCenter();
                const newP = { 
                    id: Date.now(), 
                    name: "", 
                    addr: "Position repérée", 
                    lat: c.lat, lon: c.lng, 
                    score: { qp:5, taste:5, vibe:5, total:5 }, 
                    img: null, price:{min:'', max:''} 
                };
                cancelCreation();
                savedPlaces.push(newP);
                select(newP);
                openModal();
            };

            // Modal & Form
            const openModal = () => {
                const p = selectedPlace;
                document.getElementById('e-name').value = p.name || "";
                document.getElementById('e-addr').value = p.addr || "";
                
                const s = p.score || {qp:5, taste:5, vibe:5};
                document.getElementById('r-qp').value = s.qp;
                document.getElementById('r-taste').value = s.taste;
                document.getElementById('r-vibe').value = s.vibe;
                
                document.getElementById('p-min').value = p.price?.min || "";
                document.getElementById('p-max').value = p.price?.max || "";

                currentImg = p.img;
                if(currentImg) {
                    document.getElementById('prev-img').src = currentImg;
                    document.getElementById('prev-img').style.display='block';
                    document.getElementById('lbl-img').style.display='none';
                } else {
                    document.getElementById('prev-img').style.display='none';
                    document.getElementById('lbl-img').style.display='block';
                }
                calc();
                document.getElementById('modal').classList.add('open');
            };

            const closeModal = () => document.getElementById('modal').classList.remove('open');

            const calc = () => {
                const qp = parseFloat(document.getElementById('r-qp').value);
                const t = parseFloat(document.getElementById('r-taste').value);
                const v = parseFloat(document.getElementById('r-vibe').value);
                const tot = ((qp + t + v) / 3).toFixed(1);
                document.getElementById('score-display').innerText = tot + '/10';
                return { qp, taste:t, vibe:v, total: tot };
            };

            const handleImage = (i) => {
                if(i.files[0]) {
                    const r = new FileReader();
                    r.onload = e => {
                        currentImg = e.target.result;
                        document.getElementById('prev-img').src = currentImg;
                        document.getElementById('prev-img').style.display='block';
                        document.getElementById('lbl-img').style.display='none';
                    };
                    r.readAsDataURL(i.files[0]);
                }
            };

            const save = () => {
                if(!selectedPlace) return;
                const updated = {
                    ...selectedPlace,
                    name: document.getElementById('e-name').value || "Lieu sans nom",
                    addr: document.getElementById('e-addr').value,
                    score: calc(),
                    price: { min:document.getElementById('p-min').value, max:document.getElementById('p-max').value },
                    img: currentImg
                };
                
                // Update Local Array
                const idx = savedPlaces.findIndex(x => x.id === updated.id);
                if(idx > -1) savedPlaces[idx] = updated; else savedPlaces.push(updated);
                
                // Persist
                db.transaction('places', 'readwrite').objectStore('places').put(updated);
                
                // UI
                closeModal();
                updateMap();
                select(updated);
                Drive.save(savedPlaces);
                toast("Lieu enregistré !");
            };

            const remove = () => {
                if(!confirm("Supprimer définivement ?")) return;
                db.transaction('places', 'readwrite').objectStore('places').delete(selectedPlace.id);
                savedPlaces = savedPlaces.filter(x => x.id !== selectedPlace.id);
                closeModal();
                document.getElementById('banner').classList.remove('active');
                updateMap();
                Drive.save(savedPlaces);
                toast("Lieu supprimé");
            };

            // List View & Filters
            const nav = (view) => {
                document.getElementById('nav-map').classList.toggle('active', view === 'map');
                document.getElementById('nav-list').classList.toggle('active', view === 'list');
                const lv = document.getElementById('list-view');
                if(view === 'list') { 
                    filterList('all', document.querySelector('.chip.active')); // Render list
                    lv.classList.add('open'); 
                } else { 
                    lv.classList.remove('open'); 
                }
            };

            const filterList = (criteria, chipEl) => {
                // UI Chips
                document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                if(chipEl) chipEl.classList.add('active');

                // Logic
                let data = [...savedPlaces];
                if(criteria === 'top') data = data.filter(x => (x.score?.total || 0) >= 8);
                if(criteria === 'cheap') data = data.filter(x => (x.price?.max || 999) < 30 && x.price?.max);
                if(criteria === 'photos') data = data.filter(x => x.img);
                
                // Sorting: highest score first
                data.sort((a,b) => (b.score?.total || 0) - (a.score?.total || 0));

                renderList(data);
            };

            const renderList = (data) => {
                const container = document.getElementById('list-body');
                if(!data.length) { container.innerHTML = '<div style="text-align:center; padding:40px; color:#ccc">Aucun lieu trouvé</div>'; return; }
                
                container.innerHTML = data.map(p => `
                    <div class="list-card" onclick="App.goto(${p.id})">
                        <img src="${p.img || DEF_IMG}" style="width:70px; height:70px; border-radius:10px; object-fit:cover">
                        <div style="flex:1">
                            <div style="font-weight:700; font-size:16px; margin-bottom:4px">${p.name}</div>
                            <div style="font-size:12px; color:#64748b; margin-bottom:6px">${p.addr.substring(0,30)}...</div>
                            <div style="font-size:11px; font-weight:700; color:var(--primary)">
                                <i class="fa-solid fa-star"></i> ${p.score?.total || '-'} / 10
                            </div>
                        </div>
                        <div style="font-size:12px; font-weight:600; color:#94a3b8">
                            ${p.price?.max ? p.price.max+'€' : ''}
                        </div>
                    </div>
                `).join('');
            };

            const goto = (id) => {
                nav('map');
                const p = savedPlaces.find(x => x.id === id);
                if(p) setTimeout(() => select(p), 300);
            };

            // Utils
            const applyFilters = () => updateMap(); // Trigger map refresh
            const locate = () => {
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(p => {
                        map.setView([p.coords.latitude, p.coords.longitude], 15);
                        L.circleMarker([p.coords.latitude, p.coords.longitude], {radius:8, color:'white', fillColor:'#3b82f6', fillOpacity:1}).addTo(map);
                    });
                }
            };
            const searchCity = async (val) => {
                if(val.length < 3) return;
                const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}`);
                const d = await r.json();
                if(d.length) map.setView([d[0].lat, d[0].lon], 13);
            };
            const toast = (m) => {
                const t = document.getElementById('toast');
                t.innerText = m; t.classList.add('visible');
                setTimeout(()=>t.classList.remove('visible'), 2500);
            };
            const refresh = () => updateMap();

            return { init, getData, saveAll, refresh, startCreation, cancelCreation, confirmCreation, openModal, closeModal, save, remove, handleImage, calc, nav, applyFilters, locate, filterList, goto, toast };
        })();

        window.onload = App.init;
    </script>
</body>
</html>
